#!/usr/bin/env python\n\"\"\"\nPhase 5 Verification Script - Final Cleanup & Hardening\nVerifies that all backward compatibility bridges are removed,\nsync fallbacks eliminated, and architectural guardrails enforced.\n\"\"\"\n\nimport os\nimport sys\n\n# Setup Django\nos.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')\n\nimport django\ndjango.setup()\n\nfrom django.test import Client\nfrom architectural_guardrails import ArchitecturalGuardrails\n\ndef test_bridge_files_removed():\n    \"\"\"Test that all bridge files have been removed\"\"\"\n    print(\"=== Testing Bridge Files Removed ===\")\n    \n    bridge_files = [\n        'users/notification_models_bridge.py',\n        'users/notification_serializers_bridge.py',\n        'users/notification_views_bridge.py',\n        'vessels/voyage_models_bridge.py',\n        'vessels/voyage_serializers_bridge.py',\n        'vessels/voyage_views_bridge.py',\n        'vessels/analytics_bridge.py',\n        'ports/analytics_bridge.py',\n        'voyage_history/analytics_bridge.py'\n    ]\n    \n    all_removed = True\n    for bridge_file in bridge_files:\n        if os.path.exists(bridge_file):\n            print(f\"[FAIL] Bridge file still exists: {bridge_file}\")\n            all_removed = False\n        else:\n            print(f\"[OK] Bridge file removed: {bridge_file}\")\n    \n    return all_removed\n\ndef test_direct_imports_work():\n    \"\"\"Test that direct imports work without fallbacks\"\"\"\n    print(\"\\n=== Testing Direct Imports Work ===\")\n    \n    try:\n        # Test direct imports from extracted services\n        from voyage_history.models import VoyageReplay, VoyagePosition, ComplianceViolation\n        from voyage_history.serializers import VoyageReplaySerializer\n        from voyage_history.views import VoyageReplayViewSet\n        from notifications.models import Notification, NotificationService\n        from notifications.views import NotificationViewSet\n        \n        print(\"[OK] All direct imports work successfully\")\n        return True\n    except ImportError as e:\n        print(f\"[FAIL] Direct import failed: {e}\")\n        return False\n\ndef test_sync_fallbacks_removed():\n    \"\"\"Test that synchronous fallbacks have been removed\"\"\"\n    print(\"\\n=== Testing Sync Fallbacks Removed ===\")\n    \n    try:\n        from services.external_apis import AISHubAPI, OpenWeatherAPI\n        \n        # Check that sync fallback methods don't exist\n        ais_api = AISHubAPI()\n        weather_api = OpenWeatherAPI()\n        \n        if hasattr(ais_api, '_sync_fallback'):\n            print(\"[FAIL] AISHubAPI still has _sync_fallback method\")\n            return False\n        \n        if hasattr(weather_api, '_sync_fallback'):\n            print(\"[FAIL] OpenWeatherAPI still has _sync_fallback method\")\n            return False\n        \n        print(\"[OK] All sync fallback methods removed\")\n        return True\n    except Exception as e:\n        print(f\"[FAIL] Error checking sync fallbacks: {e}\")\n        return False\n\ndef test_architectural_compliance():\n    \"\"\"Test architectural compliance using guardrails\"\"\"\n    print(\"\\n=== Testing Architectural Compliance ===\")\n    \n    try:\n        # Run architectural compliance check\n        violations = ArchitecturalGuardrails.scan_directory('.')\n        \n        total_violations = sum(len(v) for v in violations.values())\n        \n        if total_violations == 0:\n            print(\"[OK] No architectural violations found\")\n            return True\n        else:\n            print(f\"[FAIL] {total_violations} architectural violations found:\")\n            \n            for violation_type, violation_list in violations.items():\n                if violation_list:\n                    print(f\"  {violation_type}: {len(violation_list)} violations\")\n                    for v in violation_list[:3]:  # Show first 3\n                        print(f\"    - {v.get('file', 'unknown')}:{v.get('line', 'unknown')} - {v.get('message', 'unknown')}\")\n            \n            return False\n    except Exception as e:\n        print(f\"[FAIL] Error running architectural compliance: {e}\")\n        return False\n\ndef test_api_endpoints_still_work():\n    \"\"\"Test that API endpoints still work after cleanup\"\"\"\n    print(\"\\n=== Testing API Endpoints Still Work ===\")\n    \n    try:\n        client = Client()\n        \n        # Test key endpoints\n        endpoints = [\n            '/api/vessels/',\n            '/api/voyage-history/voyage-replay/',\n            '/api/notifications/',\n            '/api/analytics/admin-dashboard/',\n            '/api/ports/',\n            '/api/safety/weather/'\n        ]\n        \n        all_working = True\n        for endpoint in endpoints:\n            response = client.get(endpoint)\n            if response.status_code in [200, 401]:  # 401 is expected without auth\n                print(f\"[OK] {endpoint} accessible (status: {response.status_code})\")\n            else:\n                print(f\"[FAIL] {endpoint} returned status: {response.status_code}\")\n                all_working = False\n        \n        return all_working\n    except Exception as e:\n        print(f\"[FAIL] Error testing API endpoints: {e}\")\n        return False\n\ndef test_service_layer_usage():\n    \"\"\"Test that views are using service layer correctly\"\"\"\n    print(\"\\n=== Testing Service Layer Usage ===\")\n    \n    try:\n        # Test that service imports work\n        from services.vessel_services import VesselService\n        from services.analytics_services import AdminDashboardService\n        from services.port_services import PortService\n        from services.safety_services import WeatherAlertService\n        from services.cache_services import CacheService\n        \n        # Test service methods\n        vessels = VesselService.get_filtered_vessels()\n        user_stats = AdminDashboardService.get_user_management_stats()\n        ports = PortService.get_active_ports()\n        alerts = WeatherAlertService.get_active_weather_alerts()\n        \n        print(\"[OK] Service layer methods work correctly\")\n        return True\n    except Exception as e:\n        print(f\"[FAIL] Service layer usage test failed: {e}\")\n        return False\n\ndef test_no_orm_in_views():\n    \"\"\"Test that views don't contain direct ORM usage\"\"\"\n    print(\"\\n=== Testing No ORM in Views ===\")\n    \n    view_files = [\n        'vessels/views.py',\n        'analytics/views.py',\n        'ports/views.py',\n        'safety/views.py',\n        'notifications/views.py',\n        'voyage_history/views.py'\n    ]\n    \n    orm_violations = []\n    \n    for view_file in view_files:\n        if os.path.exists(view_file):\n            violations = ArchitecturalGuardrails.check_view_compliance(view_file)\n            orm_violations.extend(violations)\n    \n    if not orm_violations:\n        print(\"[OK] No direct ORM usage found in views\")\n        return True\n    else:\n        print(f\"[FAIL] {len(orm_violations)} ORM violations found in views\")\n        for v in orm_violations[:3]:  # Show first 3\n            print(f\"  - {v['file']}:{v['line']} - {v['pattern']}\")\n        return False\n\ndef test_async_only_external_apis():\n    \"\"\"Test that external APIs are async-only\"\"\"\n    print(\"\\n=== Testing Async-Only External APIs ===\")\n    \n    api_files = [\n        'services/external_apis.py',\n        'tasks/external_api_tasks.py',\n        'tasks/comprehensive_async_tasks.py'\n    ]\n    \n    sync_violations = []\n    \n    for api_file in api_files:\n        if os.path.exists(api_file):\n            violations = ArchitecturalGuardrails.check_async_compliance(api_file)\n            sync_violations.extend(violations)\n    \n    if not sync_violations:\n        print(\"[OK] No synchronous API calls found\")\n        return True\n    else:\n        print(f\"[FAIL] {len(sync_violations)} sync API violations found\")\n        for v in sync_violations[:3]:  # Show first 3\n            print(f\"  - {v['file']}:{v['line']} - {v['pattern']}\")\n        return False\n\ndef main():\n    \"\"\"Run all Phase 5 verification tests\"\"\"\n    print(\"Phase 5 Verification - Final Cleanup & Hardening\")\n    print(\"=\" * 60)\n    \n    tests = [\n        test_bridge_files_removed,\n        test_direct_imports_work,\n        test_sync_fallbacks_removed,\n        test_service_layer_usage,\n        test_no_orm_in_views,\n        test_async_only_external_apis,\n        test_api_endpoints_still_work,\n        test_architectural_compliance,\n    ]\n    \n    results = []\n    for test in tests:\n        try:\n            result = test()\n            results.append(result)\n        except Exception as e:\n            print(f\"[FAIL] Test {test.__name__} crashed: {e}\")\n            results.append(False)\n    \n    print(\"\\n\" + \"=\" * 60)\n    print(\"PHASE 5 VERIFICATION SUMMARY\")\n    print(\"=\" * 60)\n    \n    passed = sum(results)\n    total = len(results)\n    \n    if passed == total:\n        print(f\"ALL TESTS PASSED ({passed}/{total})\")\n        print(\"Phase 5 cleanup and hardening completed successfully!\")\n        print(\"✓ All bridge files removed\")\n        print(\"✓ All sync fallbacks eliminated\")\n        print(\"✓ Direct imports working\")\n        print(\"✓ Service layer enforced\")\n        print(\"✓ Architectural guardrails active\")\n        print(\"✓ API endpoints preserved\")\n    else:\n        print(f\"SOME TESTS FAILED ({passed}/{total})\")\n        print(\"Manual review required\")\n    \n    print(\"\\nPhase 5 Achievements:\")\n    print(\"• Removed all backward compatibility bridges\")\n    print(\"• Eliminated all synchronous fallback methods\")\n    print(\"• Enforced strict async-only external API usage\")\n    print(\"• Added architectural guardrails\")\n    print(\"• Cleaned up duplicate legacy routes\")\n    print(\"• Maintained complete functional compatibility\")\n    \n    print(\"\\nArchitectural Rules Enforced:\")\n    print(\"• Views must only call service methods (no direct ORM)\")\n    print(\"• External APIs must be async-only (no sync fallbacks)\")\n    print(\"• No bridge imports allowed (direct imports only)\")\n    print(\"• No try/except import fallbacks\")\n\nif __name__ == \"__main__\":\n    main()